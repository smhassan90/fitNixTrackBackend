// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Gym {
  id        Int      @id @default(autoincrement())
  name      String
  address   String?
  phone     String?
  email     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users             User[]
  members           Member[]
  trainers          Trainer[]
  packages          Package[]
  payments          Payment[]
  attendanceRecords AttendanceRecord[]
  deviceConfigs     DeviceConfig[]

  @@map("gyms")
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  role      UserRole @default(STAFF)
  gymId     Int
  gymName   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  gym Gym @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@map("users")
}

enum UserRole {
  GYM_ADMIN
  STAFF
}

model Member {
  id              Int       @id @default(autoincrement())
  gymId           Int
  name            String
  phone           String?
  email           String?
  gender          String?
  dateOfBirth     DateTime?
  cnic            String?   @db.VarChar(13)
  comments        String?   @db.Text
  packageId       Int?
  discount        Float?
  membershipStart DateTime?
  membershipEnd   DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  gym                Gym                 @relation(fields: [gymId], references: [id], onDelete: Cascade)
  package            Package?            @relation(fields: [packageId], references: [id], onDelete: SetNull)
  trainers           MemberTrainer[]
  payments           Payment[]
  attendanceRecords  AttendanceRecord[]
  deviceUserMappings DeviceUserMapping[]

  @@index([gymId])
  @@index([packageId])
  @@index([name])
  @@index([email])
  @@index([phone])
  @@index([cnic])
  @@index([gymId, createdAt])
  @@map("members")
}

model Trainer {
  id             Int       @id @default(autoincrement())
  gymId          Int
  name           String
  gender         String?
  dateOfBirth    DateTime?
  specialization String?   @db.Text
  charges        Float?
  startTime      String?   @db.VarChar(5) // HH:mm format
  endTime        String?   @db.VarChar(5) // HH:mm format
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  gym     Gym             @relation(fields: [gymId], references: [id], onDelete: Cascade)
  members MemberTrainer[]

  @@index([gymId])
  @@map("trainers")
}

model Package {
  id        Int      @id @default(autoincrement())
  gymId     Int
  name      String
  price     Float
  discount  Float?   @default(0) // Discount amount (optional, defaults to 0)
  duration  String // '1 month', '3 months', '6 months', '12 months'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  gym      Gym            @relation(fields: [gymId], references: [id], onDelete: Cascade)
  members  Member[]
  features PackageFeature[]

  @@index([gymId])
  @@map("packages")
}

model Feature {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  packages PackageFeature[]

  @@map("features")
}

model PackageFeature {
  packageId Int
  featureId Int
  createdAt DateTime @default(now())

  package Package @relation(fields: [packageId], references: [id], onDelete: Cascade)
  feature Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@id([packageId, featureId])
  @@index([packageId])
  @@index([featureId])
  @@map("package_features")
}

model Payment {
  id        Int           @id @default(autoincrement())
  gymId     Int
  memberId  Int
  month     String        @db.VarChar(7) // Format: 'YYYY-MM'
  amount    Float
  status    PaymentStatus @default(PENDING)
  dueDate   DateTime
  paidDate  DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  gym    Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)
  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([gymId])
  @@index([memberId])
  @@index([status])
  @@index([dueDate])
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
}

model AttendanceRecord {
  id                 Int              @id @default(autoincrement())
  gymId              Int
  memberId           Int
  date               DateTime         @db.Date // Date only (no time)
  status             AttendanceStatus @default(PRESENT)
  checkInTime        DateTime? // Check-in timestamp from device
  checkOutTime       DateTime? // Check-out timestamp from device
  deviceUserId       String? // User ID from ZKTeco device
  deviceSerialNumber String? // Device serial number
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  gym    Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)
  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([gymId, memberId, date])
  @@index([gymId])
  @@index([memberId])
  @@index([date])
  @@index([deviceUserId])
  @@index([checkInTime])
  @@map("attendance_records")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
}

model MemberTrainer {
  memberId  Int
  trainerId Int
  createdAt DateTime @default(now())

  member  Member  @relation(fields: [memberId], references: [id], onDelete: Cascade)
  trainer Trainer @relation(fields: [trainerId], references: [id], onDelete: Cascade)

  @@id([memberId, trainerId])
  @@index([memberId])
  @@index([trainerId])
  @@map("member_trainers")
}

model DeviceConfig {
  id             Int       @id @default(autoincrement())
  gymId          Int
  name           String // Device name/identifier
  ipAddress      String // Device IP address
  port           Int       @default(4370) // Default ZKTeco port
  serialNumber   String? // Device serial number
  isActive       Boolean   @default(true)
  lastSyncAt     DateTime? // Last successful sync timestamp
  syncInterval   Int       @default(300) // Sync interval in seconds (5 minutes default)
  deviceUserId   String? // Admin user ID on device (optional)
  devicePassword String? // Admin password on device (optional)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  gym          Gym                 @relation(fields: [gymId], references: [id], onDelete: Cascade)
  userMappings DeviceUserMapping[]

  @@unique([gymId, ipAddress, port])
  @@index([gymId])
  @@index([isActive])
  @@map("device_configs")
}

model DeviceUserMapping {
  id             Int      @id @default(autoincrement())
  deviceConfigId Int
  memberId       Int
  deviceUserId   String // User ID on the ZKTeco device
  deviceUserName String? // Name on the device
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  deviceConfig DeviceConfig @relation(fields: [deviceConfigId], references: [id], onDelete: Cascade)
  member       Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([deviceConfigId, deviceUserId])
  @@unique([deviceConfigId, memberId])
  @@index([deviceConfigId])
  @@index([memberId])
  @@index([deviceUserId])
  @@map("device_user_mappings")
}
